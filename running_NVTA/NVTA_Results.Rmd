---
title: "NVTA_Results"
author: "Volpe Center (Sarah Lohmar, Dan Flynn, Eric Englin)"
date: "6/24/2021"
output:
  html_document:
    df_print: paged
    fig_caption: yes
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

## Initial Findings 

The Volpe team started by looking at the daily VMT for all scenarios. This is done by combining seven DVMT outputs by location and type of mode. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

ve.runtime <- ifelse(grepl('Flynn', normalizePath('~/')), 
                     file.path(dirname('~/'), 'Desktop/VE_4-1-0/'),
                      ifelse(grepl('lohmar', normalizePath('~/')), 
                       'C:/VisionEval',
                         ifelse(grepl('englin', normalizePath('~/')), 
                         file.path('C:/Users/eric.englin/Desktop/VisionEval/4_04_v3/'),
                          NA)))

knitr::opts_knit$set(root.dir = ve.runtime)

library(tidyverse)
library(plotly) #install.packages('plotly')

```


```{r dvmt_plot}
readfile <- read.csv(file.path(ve.runtime, 'models', 'Scenario_Metrics_Marea_with_Base.csv'))

#info for regional dvmt graphic (summing cols b-h)
dvmt <- readfile[ ,c(1,2,3,4,5,6,7,8)]
dvmt$regionalDVMT = rowSums(dvmt[,c(-1)])
dvmtbase = dvmt[1,9]
dvmt$modelName = substring(dvmt$modelName,8,15)
dvmt[1,1] = "NVTA_Base"
dvmt$regDVMTAbsDif = dvmt$regionalDVMT - dvmtbase
dvmt$regDVMTPerChange = (dvmt$regDVMTAbsDif/dvmtbase)*100
dvmt$color <- ifelse(dvmt$regDVMTPerChange > 0, "red","green")

dvmtplot1 <- data.frame(Model = dvmt$modelName,PercentChange = dvmt$regDVMTPerChange, 
                        color = dvmt$color)

gp1 <- ggplot(dvmtplot1, aes(x=Model, y=PercentChange, fill = color)) +
  geom_bar(stat="identity") + theme_minimal() +
  scale_fill_manual(values = c('tomato', 'lightgreen'),
                    guide = F) +
  labs(title = "Percent Change Regional DVMT", x = "Model Name", y = "Percent Change")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(gp1)

dvmtplot2 <- data.frame(Model = dvmt$modelName,AbsoluteChange = dvmt$regDVMTAbsDif, 
                        color = dvmt$color)

gp2 <- ggplot(dvmtplot2, aes(x=Model, y=AbsoluteChange, fill = color)) + 
  geom_bar(stat="identity") + theme_minimal() +
  scale_fill_manual(values = c('tomato', 'lightgreen'), guide = F) +
  labs(title = "Absolute Change Regional DVMT", x = "Model Name", y = "Absolute Change")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplotly(gp2)


#info for commercial heavy truck gge (sum columns k-m)
gge <- readfile[ , c(1,11,12,13)]
gge$modelName = substring(gge$modelName,8,15)
gge[1,1] = "NVTA_Base"
gge$ComHvyTruckGGE = rowSums(gge[,c(-1)])
ggebase = gge[1,5]
gge$ComHvyTruckGGEAbsDif = gge$ComHvyTruckGGE - ggebase
gge$ComHvyTruckGGEPerChange = (gge$ComHvyTruckGGEAbsDif/ggebase) *100
gge$color <- ifelse(gge$ComHvyTruckGGEPerChange > 0, "red","green")



ggeplot1 <- data.frame(Model = gge$modelName,PercentChange = gge$ComHvyTruckGGEPerChange,
                       color = gge$color)

gp3 <- ggplot(ggeplot1, aes(x=Model, y=PercentChange, fill=color)) + 
  geom_bar(stat="identity") + theme_minimal() +
  scale_fill_manual(values = c('tomato', 'lightgreen'),
                    guide = F) +
  labs(title = "Percent Change Com Hvy Truck GGE", x = "Model Name", y ="Percent Change")+
  theme(axis.text.x = element_text(angle = 45))

ggplotly(gp3)



# Household Data Visualization
hhfile <- read.csv(file.path(ve.runtime, 'models', 'Scenario_Metrics_Hh_with_Base.csv'))
baseNVTA <- hhfile[hhfile$modelName=="VERSPM_NVTA",]



csvpath <- file.path(ve.runtime,"models","Scenario_Status.csv")
data <- read.csv(csvpath)

hh_sum_stat <- data.frame()

for(i in 1:nrow(data)){
  name <- data[i, "name"]
  
  stats <- c(name,sum(hhfile$DailyGGE[hhfile$modelName==name]),
  sum(hhfile$DailyKWH[hhfile$modelName==name]),
  sum(hhfile$DailyCO2e[hhfile$modelName==name]))
  
  hh_sum_stat <- rbind(hh_sum_stat,stats)
  
}
colnames(hh_sum_stat) <- c("ModelName", "RegHhDailyGGE", 
                            "RegHhDailyKWH",
                            "RegHhDailyCO2e")
rownames(hh_sum_stat) <- NULL

baseGGE = as.numeric(hh_sum_stat[1,2])
baseKWH = as.numeric(hh_sum_stat[1,3])
baseCO2 = as.numeric(hh_sum_stat[1,4])

hh_sum_stat$ModelName = substring(hh_sum_stat$ModelName,8,15)
hh_sum_stat[1,1] = "NVTA_Base"

hh_sum_stat$GGEPerChange = ((as.numeric(hh_sum_stat$RegHhDailyGGE) - baseGGE)/baseGGE)*100
hh_sum_stat$KWHPerChange = ((as.numeric(hh_sum_stat$RegHhDailyKWH) - baseKWH)/baseKWH)*100
hh_sum_stat$CO2PerChange = ((as.numeric(hh_sum_stat$RegHhDailyCO2e) - baseCO2)/baseCO2)*100

hhgge <- data.frame(Model = hh_sum_stat$ModelName,GGE = hh_sum_stat$RegHhDailyGGE)
hhkwh <- data.frame(Model = hh_sum_stat$ModelName,KWH = hh_sum_stat$RegHhDailyKWH)
hhco2 <-data.frame(Model = hh_sum_stat$ModelName,CO2 = hh_sum_stat$RegHhDailyCO2e)

ggplot(hhgge, aes(x=Model, y=GGE)) + 
  geom_bar(stat="identity") + theme_minimal() +
  labs(title = "Regional GGE", x = "Model Name", y ="GGE/Day")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(hhkwh, aes(x=Model, y=KWH)) + 
  geom_bar(stat="identity") + theme_minimal() +
  labs(title = "Regional KWH", x = "Model Name", y ="GGE/Day")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(hhco2, aes(x=Model, y=CO2)) + 
  geom_bar(stat="identity") + theme_minimal() +
  labs(title = "Regional KWH", x = "Model Name", y ="KG/Day")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Validation 

The Volpe team also realized the need to validate the VisionEval output. 

#### MWCOG DVMT
The VDOT team sent along daily VMT values in 2021 and 2045 from the MWCOG MOE Base model. These results include household car VMT, business car VMT, and car travel from other locations (such as motorists who live outside the area and are passing through it.

Here are the raw results from the MWCOG base model in 2045:

       Jurisdiction  Freeway     Expressway  Major Art.  Minor Art.   Collector     Ramp       All
-------------------- ----------- ----------- ----------- ----------- ----------- ----------- -----------
 Fairfax County      12,517,806   5,910,760   6,219,736   1,419,677   1,256,563     488,882  27,813,424
 City of Fairfax              0     284,867      99,406       9,144           0           0     393,417
 Falls Church                 0     106,172      40,693       4,605           0           0     151,470
 
 
CROSSTAB ROW=FLAG COL=FTYPE VAR=_24VMTTRK
                                                                                                       
       Jurisdiction  Freeway     Expressway  Major Art.  Minor Art.   Collector     Ramp       All
-------------------- ----------- ----------- ----------- ----------- ----------- ----------- -----------
Fairfax County        3,071,425     988,206     919,784     212,966     331,425      90,603   5,614,408
City of Fairfax               0      37,640      12,957         774           0           0      51,371
Falls Church                  0      18,944       5,575         425           0           0      24,944



When you add all of the numbers up, you get 34,049,034 daily VMTs. This is about 4,000,000 higher than the VisionEval dvmt values. The chart below shows the percent differences with each of our scenarios. 

```{r dvmt_plot_validation}

ffx_county_car_2045 = 27813424
ffx_city_car_2045 = 393417
fall_church_car_2045 = 151470
ffx_county_truck_2045 = 5614408
ffx_city_truck_2045 = 51371
fall_church_truck_2045 = 24944

MWCOG_model_dvmt = ffx_county_car_2045+ffx_city_car_2045+fall_church_car_2045+ffx_county_truck_2045+ffx_city_truck_2045+fall_church_truck_2045

#trip_generation_summary_motorized_dvmt = 3649551
#trip_generation_summary_non_motorized_dvmt = 317247

dvmt$regDVMTAbsDif = dvmt$regionalDVMT - MWCOG_model_dvmt
dvmt$regDVMTPerChange = (dvmt$regDVMTAbsDif/MWCOG_model_dvmt)*100
dvmt$color <- ifelse(dvmt$regDVMTPerChange < 0, "red","green")

dvmtplot1 <- data.frame(Model = dvmt$modelName,PercentChange = dvmt$regDVMTPerChange, 
                        color = dvmt$color)

ggplot(dvmtplot1, aes(x=Model, y=PercentChange, fill = color)) + 
  geom_bar(stat="identity") + theme_minimal() +
  labs(title = "Percent Change VisionEval DVMT and MWCOG MOES Base Model for 2045", x = "Model Name", y = "Percent Change")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


Here is a table showing some of the validation steps taken:

| File from the Travel Demand Model | Value       | Output from NOVA model | Output from VisionEval (Base Model) | Percent Difference |
| --------------------------------- | ----------  | ---------------------- | ----------------------------------  | ------------------ |
| 2019i4_Trip_Generation_Summary.txt | HH DVMT    | 34,049,034             | 30,040,347                          | 5-15%              |
| 2019i4_Trip_Generation_Summary.txt | Truck DVMT | 5,690,723              | 1,206,452                           | 70-80%              |

